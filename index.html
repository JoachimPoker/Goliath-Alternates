<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    window.onerror = function(msg, url, lineNo, columnNo, error) {
      alert("Error: " + msg + "\nLine: " + lineNo);
      return false;
    };
  </script>
  <title>Goliath Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="main.css">
  <style>
    body { padding-top: 6vh; } 
    .ticker-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 6vh; z-index: 9999; }
  </style>
</head>
<body>
  <div class="ticker-wrap" style="display:none;">
    <div class="ticker-content" id="tickerText"></div>
  </div>

  <div class="container py-4">
    <div class="text-center mb-4 border-bottom border-secondary pb-3">
      <h2 style="color:var(--text-gold); font-weight:900; letter-spacing:1px;">GOLIATH HUB</h2>
      <p class="text-secondary small">LIVE TOURNAMENT TRACKER</p>
    </div>

    <div id="tournamentList"></div>

    <div class="flat-card mt-5">
      <h4 class="text-white mb-3">Find Your Table</h4>
      <input type="text" id="mapSearch" class="form-control map-input mb-3" placeholder="Enter Table # (e.g. 45)">
      <div style="position:relative; border: 2px solid #444; border-radius:8px; overflow:hidden;">
        <img src="map.jpg" class="img-fluid" style="opacity:0.8; width:100%;">
        <div id="mapPointer" class="map-pointer"></div>
      </div>
      <div id="mapFeedback" class="mt-2 fw-bold text-center"></div>
    </div>
  </div>

  <div class="modal fade" id="subModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark border-secondary text-white">
        <div class="modal-header border-secondary">
          <h5 class="modal-title">Track Your Seat</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>We will alert you when your number is called.</p>
          <input type="hidden" id="modalTournId">
          <input type="number" id="userAltNumber" class="form-control map-input mb-3" placeholder="e.g. 55">
          <button onclick="saveSubscription()" class="btn btn-warning w-100 fw-bold">START TRACKING</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  
  <script>
    // --- 1. LOAD TICKER ---
    async function loadTicker() {
      const { data } = await _supabase.from('messages').select('*').eq('show_on_home', true).order('created_at');
      const tickerBox = document.getElementById('tickerText');
      const wrap = document.querySelector('.ticker-wrap');
      
      if (!data || data.length === 0) {
        wrap.style.display = 'none';
        document.body.style.paddingTop = '20px';
      } else {
        wrap.style.display = 'flex';
        document.body.style.paddingTop = '8vh';
        
        const baseString = data.map(m => m.text).join(' &nbsp;&nbsp;&nbsp;***&nbsp;&nbsp;&nbsp; ');
        const repeatedString = Array(20).fill(baseString).join(' &nbsp;&nbsp;&nbsp;***&nbsp;&nbsp;&nbsp; ');
        tickerBox.innerHTML = `<div class="ticker-item">${repeatedString}</div>`;
        
        const pixelsPerSecond = 100; 
        const totalWidth = tickerBox.scrollWidth;
        const duration = totalWidth / pixelsPerSecond;
        tickerBox.style.animationDuration = `${duration}s`;
      }
    }

    // --- 2. LOAD HOME (Updated with Empty Check) ---
    let subscriptions = JSON.parse(localStorage.getItem('goliath_subs') || '{}');
    if ("Notification" in window) Notification.requestPermission();

    async function loadHome() {
      // DEBUG: Ask for both data AND error
      const { data, error } = await _supabase
        .from('tournaments')
        .select('*')
        .eq('is_active', true)
        .order('created_at');

      // 1. ERROR CHECK
      if (error) {
        alert("PHONE ERROR: " + error.message); // This tells us exactly what's wrong
        return;
      }

      const list = document.getElementById('tournamentList');

      // 2. EMPTY CHECK
      if (!data || data.length === 0) {
        list.innerHTML = `
          <div class="text-center py-5 text-secondary">
            <h3 class="fw-bold" style="opacity:0.5;">NO ACTIVE EVENTS</h3>
            <p>If you see this but events exist, check Database RLS Policies.</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = data.map(t => {
        const subData = subscriptions[t.id]; 
        const isTracking = subData !== undefined;
        let alertUI = '';

        if (isTracking) {
           const hasBeenCalled = t.current_alt_number >= subData.num;
           if (hasBeenCalled) {
             if (!subData.notified) { triggerAlert(t.name, t.current_alt_number); markAsNotified(t.id); }
             alertUI = `<div class="called-box mt-2"><h2 class="fw-bold mb-0">SEAT READY!</h2><div class="small text-white">FOR ${t.name}</div><button onclick="clearSub('${t.id}')" class="btn btn-light btn-sm fw-bold w-100 mt-2">I'M HERE</button></div>`;
           } else {
             alertUI = `<div class="tracking-box mt-2"><div class="fw-bold text-info">TRACKING #${subData.num}</div><div class="small text-muted mb-2">in ${t.name}</div><button onclick="clearSub('${t.id}')" class="btn btn-sm btn-outline-secondary w-100">CANCEL</button></div>`;
           }
        } else {
           alertUI = t.is_alternate_active ? `<button onclick="openSubModal('${t.id}')" class="btn-notify mt-2">NOTIFY ME</button>` : '';
        }

        return `
        <div class="flat-card">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <span class="badge bg-dark border border-secondary">${t.start_time}</span>
            <span class="${t.is_alternate_active ? 'badge-alt' : 'badge-open'}">${t.is_alternate_active ? 'ALT LIST' : 'OPEN'}</span>
          </div>
          <div class="tourn-title">${t.name}</div>
          <div class="tourn-info">${t.location}</div>
          <div class="row align-items-end border-top border-secondary pt-3">
            <div class="col-6">
              <div class="small text-muted fw-bold">NOW CALLING</div>
              <div class="display-4 fw-bold text-warning" style="line-height:1">${t.is_alternate_active ? '#' + t.current_alt_number : 'ALL ALTERNATES'}</div>
            </div>
            <div class="col-6">${alertUI}</div>
          </div>
        </div>
      `}).join('');
    }

    // --- 3. HELPERS ---
    const modal = new bootstrap.Modal(document.getElementById('subModal'));
    function openSubModal(id) { document.getElementById('modalTournId').value = id; modal.show(); }
    function saveSubscription() { 
      const id = document.getElementById('modalTournId').value;
      const num = parseInt(document.getElementById('userAltNumber').value);
      if(!num) return alert("Enter number");
      subscriptions[id] = { num: num, notified: false };
      localStorage.setItem('goliath_subs', JSON.stringify(subscriptions));
      modal.hide(); loadHome();
    }
    function clearSub(id) { delete subscriptions[id]; localStorage.setItem('goliath_subs', JSON.stringify(subscriptions)); loadHome(); }
    function markAsNotified(id) { if(subscriptions[id]) { subscriptions[id].notified = true; localStorage.setItem('goliath_subs', JSON.stringify(subscriptions)); } }
    function triggerAlert(name, currentNum) { 
      if(navigator.vibrate) navigator.vibrate([500,200,500]); 
      if(Notification.permission==="granted") { new Notification(`SEAT READY: ${name}`, { body: `Go to the desk! They are calling #${currentNum}` }); }
      alert(`SEAT READY FOR: ${name}\n\nThey are calling #${currentNum}`); 
    }

    // Map Logic
    document.getElementById('mapSearch').addEventListener('input', async (e) => {
      const val = e.target.value; const ptr = document.getElementById('mapPointer');
      if(!val) { ptr.style.display='none'; return; }
      const { data } = await _supabase.from('table_map').select('*').eq('table_number', val).single();
      if(data) { ptr.style.display='block'; ptr.style.left=data.x_percent+'%'; ptr.style.top=data.y_percent+'%'; }
      else ptr.style.display='none';
    });

    _supabase.channel('public').on('postgres_changes', {event:'*', schema:'public'}, () => { loadHome(); loadTicker(); }).subscribe();
    loadHome();
    loadTicker();
  </script>
</body>
</html>
