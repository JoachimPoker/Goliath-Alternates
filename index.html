<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    window.onerror = function(msg, url, lineNo, columnNo, error) {
      alert("Error: " + msg + "\nLine: " + lineNo);
      return false;
    };
  </script>
  <title>Goliath Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="main.css">
  <style>
    body { padding-top: 6vh; } 
    .ticker-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 6vh; z-index: 9999; }
    
    /* Upcoming Card Style */
    .upcoming-card {
      background: #1e1e2f;
      border: 1px solid #444;
      border-left: 5px solid #6c757d; /* Grey accent */
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="ticker-wrap" style="display:none;">
    <div class="ticker-content" id="tickerText"></div>
  </div>

  <div class="container py-4">
    <div class="text-center mb-4 border-bottom border-secondary pb-3">
      <h2 style="color:var(--text-gold); font-weight:900; letter-spacing:1px;">GOLIATH HUB</h2>
      <p class="text-secondary small">LIVE TOURNAMENT TRACKER</p>
    </div>

    <div id="tournamentList"></div>

    <div class="flat-card mt-5">
      <h4 class="text-white mb-3">Find Your Table</h4>
      <input type="text" id="mapSearch" class="form-control map-input mb-3" placeholder="Enter Table # (e.g. 45)">
      <div style="position:relative; border: 2px solid #444; border-radius:8px; overflow:hidden;">
        <img src="map.jpg" class="img-fluid" style="opacity:0.8; width:100%;">
        <div id="mapPointer" class="map-pointer"></div>
      </div>
      <div id="mapFeedback" class="mt-2 fw-bold text-center"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  
  <script>
    // --- 1. LOAD TICKER ---
    async function loadTicker() {
      const { data } = await _supabase.from('messages').select('*').eq('show_on_home', true).order('created_at');
      const tickerBox = document.getElementById('tickerText');
      const wrap = document.querySelector('.ticker-wrap');
      
      if (!data || data.length === 0) {
        wrap.style.display = 'none';
        document.body.style.paddingTop = '20px';
      } else {
        wrap.style.display = 'flex';
        document.body.style.paddingTop = '8vh';
        
        const baseString = data.map(m => m.text).join(' &nbsp;&nbsp;&nbsp;***&nbsp;&nbsp;&nbsp; ');
        const repeatedString = Array(20).fill(baseString).join(' &nbsp;&nbsp;&nbsp;***&nbsp;&nbsp;&nbsp; ');
        tickerBox.innerHTML = `<div class="ticker-item">${repeatedString}</div>`;
        
        const pixelsPerSecond = 100; 
        const totalWidth = tickerBox.scrollWidth;
        const duration = totalWidth / pixelsPerSecond;
        tickerBox.style.animationDuration = `${duration}s`;
      }
    }

    // --- 2. LOAD HOME (Smart Logic) ---
    async function loadHome() {
      const list = document.getElementById('tournamentList');

      // A. Try to fetch ACTIVE events first
      const { data: activeData, error } = await _supabase.from('tournaments').select('*').eq('is_active', true).order('created_at');
      
      if (activeData && activeData.length > 0) {
        // --- RENDER ACTIVE EVENTS ---
        list.innerHTML = activeData.map(t => {
          let mainText = "";
          let mainColor = "text-white"; 

          if (t.status_mode === 'OPEN') { mainText = "IMMEDIATE SEATING"; mainColor = "text-success"; } 
          else if (t.status_mode === 'ALL') { mainText = "ALL ALTERNATES"; mainColor = "text-danger"; } 
          else if (t.status_mode === 'BREAK') { mainText = `AFTER BREAK: UP TO #${t.current_alt_number}`; mainColor = "text-info"; } 
          else { mainText = `CALLING UP TO #${t.current_alt_number}`; mainColor = "text-warning"; }

          return `
          <div class="flat-card">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <span class="badge bg-dark border border-secondary">${t.start_time}</span>
              <span class="badge bg-dark border border-secondary">${t.location || 'TBD'}</span>
            </div>
            <div class="tourn-title">${t.name}</div>
            <div class="row align-items-end border-top border-secondary pt-3 mt-2">
              <div class="col-12 text-center">
                <div class="display-5 fw-bold ${mainColor}" style="line-height:1.1">${mainText}</div>
              </div>
            </div>
          </div>`;
        }).join('');
        return;
      }

      // B. If NO ACTIVE events, fetch UPCOMING (Calendar)
      // Get today's date in YYYY-MM-DD format
      const today = new Date().toISOString().split('T')[0];
      
      const { data: upcomingData } = await _supabase
        .from('tournaments')
        .select('*')
        .eq('is_active', false)
        .gte('tournament_date', today) // Only future/today
        .order('tournament_date', { ascending: true })
        .order('start_time', { ascending: true })
        .limit(5); // Show next 5 events

      if (!upcomingData || upcomingData.length === 0) {
        list.innerHTML = `<div class="text-center py-5 text-secondary"><h3>NO ACTIVE EVENTS</h3></div>`;
        return;
      }

      // --- RENDER UPCOMING SCHEDULE ---
      let html = `<div class="text-center mb-4"><h4 class="text-secondary fw-bold" style="letter-spacing:1px; opacity:0.7;">UPCOMING SCHEDULE</h4></div>`;
      
      html += upcomingData.map(t => `
        <div class="upcoming-card">
          <div class="d-flex justify-content-between align-items-center">
            <div>
               <div style="color:var(--text-gold); font-weight:bold; font-size:0.85rem;">${t.tournament_date}</div>
               <div class="fw-bold text-white" style="font-size: 1.2rem;">${t.name}</div>
            </div>
            <div class="text-end">
               <span class="badge bg-secondary">${t.start_time}</span>
            </div>
          </div>
          <div class="mt-2 text-muted small border-top border-secondary pt-2" style="border-style:dashed!important;">
             Location: ${t.location || 'TBD'}
          </div>
        </div>
      `).join('');

      list.innerHTML = html;
    }

    // --- 3. HELPERS ---
    document.getElementById('mapSearch').addEventListener('input', async (e) => {
      const val = e.target.value; const ptr = document.getElementById('mapPointer');
      if(!val) { ptr.style.display='none'; return; }
      const { data } = await _supabase.from('table_map').select('*').eq('table_number', val).single();
      if(data) { ptr.style.display='block'; ptr.style.left=data.x_percent+'%'; ptr.style.top=data.y_percent+'%'; }
      else ptr.style.display='none';
    });

    _supabase.channel('public').on('postgres_changes', {event:'*', schema:'public'}, () => { loadHome(); loadTicker(); }).subscribe();
    loadHome();
    loadTicker();
  </script>
</body>
</html>